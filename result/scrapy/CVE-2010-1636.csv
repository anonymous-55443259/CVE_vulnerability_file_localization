"url","domain","state","text"
"https://bugs.launchpad.net/ubuntu/+source/linux/+bug/579585","bugs.launchpad.net","0","btrfs security issues (information disclosure, insufficient permission checking)
Bug #579585 reported by
Dan Rosenberg
on 2010-05-12
260
This bug affects 1 person
Affects
Status
Importance
Assigned to
Milestone
linux (Ubuntu)
Fix Released
High
Unassigned
Lucid
Fix Released
High
Unassigned
Bug Description
I have discovered two security issues in btrfs, tested on kernel 2.6.32-22-generic on Lucid.  I've confirmed that these issues affect all versions >= 2.6.29.  I've reported these issues to <email address hidden>, but am posting it here so there's a record that it affects Ubuntu.
1.  The btrfs_ioctl_clone() ioctl, which copies the provided source file descriptor to a destination file descriptor, fails to check that the source file descriptor has been opened for reading before copying.  This can allow an attacker to copy (and subsequently read) files without read permission.  I've attached a simple reproducer (exploit.c) to verify the issue, which can be tested as follows:
$ dd if=/dev/zero of=fs.iso bs=1M count=500
$ losetup  /dev/loop7 fs.iso
$ mkfs.btrfs /dev/loop7
$ mkdir mountpoint
$ mount /dev/loop7 mountpoint
$ cd mountpoint
$ echo ""This is a write-only file"" > target
$ chmod 200 target
$ ./exploit target output
$ cat output
This is a write-only file
2.  btrfs_ioctl_trans_start() requires CAP_SYS_ADMIN to start a transaction, but btrfs_ioctl_trans_end() does not, allowing unprivileged users to end other users' transactions.  While the security implications of this are a bit unclear, it seems unwise especially given the warnings about how transactions should only be started and ended by privileged processes, given the chance of deadlock.
I've attached a patch that requires CAP_SYS_ADMIN to end transactions and checks read permissions on the source file for the clone ioctl (btrfs.patch).
Tags:
patch
kernel-fs
kernel-reviewed
kernel-security
kj-triage
Revision history for this message
Dan Rosenberg (dan-j-rosenberg)
wrote
on 2010-05-12:
#1
Reproducer for clone ioctl vulnerability
Edit
(443 bytes,
text/plain)
Revision history for this message
Dan Rosenberg (dan-j-rosenberg)
wrote
on 2010-05-12:
#2
Fix for btrfs clone ioctl and transaction ending
Edit
(635 bytes,
text/plain)
Revision history for this message
Dan Rosenberg (dan-j-rosenberg)
wrote
on 2010-05-18:
#3
Made public with commit:
http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395
Second item listed was identified as not being a security issue and may not be necessary to ""fix"".
visibility:
private → public
Jeremy Foshee (jeremyfoshee)
on 2010-05-24
tags:
added: kj-triage
Brian Murray (brian-murray)
on 2010-05-24
tags:
added: patch
Jeremy Foshee (jeremyfoshee)
on 2010-05-25
Changed in linux (Ubuntu):
status:
New → Triaged
importance:
Undecided → High
tags:
added: kernel-fs kernel-needs-review
Andy Whitcroft (apw)
on 2010-05-26
tags:
added: kernel-reviewed-kernel-candidate kernel-securityremoved: kernel-needs-review
Andy Whitcroft (apw)
on 2010-05-26
tags:
added: kernel-candidate kernel-reviewedremoved: kernel-reviewed-kernel-candidate
Andy Whitcroft (apw)
on 2010-06-07
tags:
removed: kernel-candidate
Stefan Bader (smb)
on 2010-07-14
Changed in linux (Ubuntu):
assignee:
nobody → Stefan Bader (stefan-bader-canonical)
Revision history for this message
Stefan Bader (smb)
wrote
on 2010-09-03:
#4
This fix is included in Maverick.
Changed in linux (Ubuntu):
assignee:
Stefan Bader (stefan-bader-canonical) → nobody
status:
Triaged → Fix Released
Revision history for this message
Stefan Bader (smb)
wrote
on 2010-09-03:
#5
The fix mentioned was actually released in Lucid with 2.6.32-23.37 as part of an upstream stable update. Sorry for missing the relation to this bug report.
Changed in linux (Ubuntu Lucid):
importance:
Undecided → High
status:
New → Fix Released
See full activity log
To post a comment you must log in."
"http://www.openwall.com/lists/oss-security/2010/05/18/10","www.openwall.com","0","
Date: Tue, 18 May 2010 13:44:40 -0400
From: Dan Rosenberg <dan.j.rosenberg@...il.com>
To: oss-security@...ts.openwall.com
Cc: coley@...us.mitre.org
Subject: Re: kernel: btrfs: check for read permission on src 
	file in the clone ioctl

Ubuntu 10.4 ships with a kernel that supports btrfs:

https://bugs.launchpad.net/ubuntu/+source/linux/+bug/579585

In case the bug description needs clarification, the bug allows an
unprivileged user to clone files that can be opened for writing
without read permissions.  Since cloning results in the creation of a
duplicate copy owned by the user who performed the cloning operation,
this is an information disclosure vulnerability.

-Dan

On Tue, May 18, 2010 at 5:13 AM, Eugene Teo <eugene@...hat.com> wrote:
> The existing [btrfs] code would have allowed you to clone a file that was
> only open for writing. Not an expected behaviour.
>
> Upstream commit:
> http://git.kernel.org/linus/5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395
>
> Reference:
> https://bugzilla.redhat.com/show_bug.cgi?id=593226
>
> I'm not requesting a CVE name for this as it did not affect any of Red Hats'
> supported Linux kernels.
>
> Thanks, Eugene
> --
> main(i) { putchar(182623909 >> (i-1) * 5&31|!!(i<7)<<6) && main(++i); }
>
"
"http://www.openwall.com/lists/oss-security/2010/05/18/2","www.openwall.com","0","
Date: Tue, 18 May 2010 17:13:55 +0800
From: Eugene Teo <eugene@...hat.com>
To: oss-security@...ts.openwall.com
CC: coley@...us.mitre.org
Subject: kernel: btrfs: check for read permission on src file in the clone
 ioctl

The existing [btrfs] code would have allowed you to clone a file that 
was only open for writing. Not an expected behaviour.

Upstream commit:
http://git.kernel.org/linus/5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395

Reference:
https://bugzilla.redhat.com/show_bug.cgi?id=593226

I'm not requesting a CVE name for this as it did not affect any of Red 
Hats' supported Linux kernels.

Thanks, Eugene
-- 
main(i) { putchar(182623909 >> (i-1) * 5&31|!!(i<7)<<6) && main(++i); }
"
"http://www.openwall.com/lists/oss-security/2010/05/25/8","www.openwall.com","0","
Date: Tue, 25 May 2010 14:01:17 -0400 (EDT)
From: Josh Bressers <bressers@...hat.com>
To: oss-security@...ts.openwall.com
Cc: coley@...us.mitre.org
Subject: Re: kernel: btrfs: check for read permission on src
 file in the clone ioctl

Please use CVE-2010-1636

Thanks.

-- 
    JB


----- ""Eugene Teo"" <eugene@...hat.com> wrote:

> The existing [btrfs] code would have allowed you to clone a file that
> 
> was only open for writing. Not an expected behaviour.
> 
> Upstream commit:
> http://git.kernel.org/linus/5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395
> 
> Reference:
> https://bugzilla.redhat.com/show_bug.cgi?id=593226
> 
> I'm not requesting a CVE name for this as it did not affect any of Red
> 
> Hats' supported Linux kernels.
> 
> Thanks, Eugene
> -- 
> main(i) { putchar(182623909 >> (i-1) * 5&31|!!(i<7)<<6) && main(++i);
> }
"
"https://bugzilla.redhat.com/show_bug.cgi?id=593226","bugzilla.redhat.com","0","Title:
CVE-2010-1636 kernel: btrfs: check for read permission on src file in the clone ioctl

Attributes:
Keywords:
Security
Status:
CLOSED
          ERRATA
Alias:
CVE-2010-1636
Product:
Security Response
Classification:
Other
Component:
vulnerability
Sub Component:
---
Version:
unspecified
Hardware:
All
OS:
        Linux
Priority:
medium
Severity:
       medium
Target Milestone:
---
Assignee:
Red Hat Product Security
QA Contact:
Docs Contact:
URL:
Whiteboard:
Depends On:
593227
Blocks:
TreeView+
        depends on /
        blocked
Reported:
2010-05-18 09:02 UTC by Eugene Teo (Security Response)
Modified:
2023-05-11 12:19 UTC
      (History)
CC List:
7 
          users
            (show)
arozansk
davej
eguan
kmcmartin
lwang
pmatouse
tcallawa
Fixed In Version:
Doc Type:
Bug Fix
Doc Text:
Clone Of:
Environment:
Last Closed:
2012-03-28 08:46:30 UTC
Embargoed:


Comments:
Description
Eugene Teo (Security Response)
          2010-05-18 09:02:16 UTC
Description of problem:
The existing [btrfs] code would have allowed you to clone a file that was only open for writing. Not an expected behaviour.
Upstream commit:
http://git.kernel.org/linus/5dc6416414fb3ec6e2825fd4d20c8bf1d7fe0395
Reference:
https://btrfs.wiki.kernel.org/index.php/Main_Page
The kernel in Red Hat Enterprise Linux 6 has support for Btrfs by default.
Acknowledgements:
Red Hat would like to thank Dan Rosenberg for responsibly reporting this issue.
Comment 2
Eugene Teo (Security Response)
          2010-05-18 09:11:09 UTC
Statement:
Not vulnerable. This issue did not affect the versions of Linux kernel as shipped with Red Hat Enterprise Linux 3, 4, 5 and Red Hat Enterprise MRG as they did not include support for Btrfs, a new copy on write filesystem.
Comment 3
Eugene Teo (Security Response)
          2010-05-19 01:16:07 UTC
Created attachment 414994 [details]
exploit.c
The steps to reproduce the issue and exploit.c were made publicly available in: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/579585
$ dd if=/dev/zero of=fs.iso bs=1M count=500
$ losetup /dev/loop7 fs.iso
$ mkfs.btrfs /dev/loop7
$ mkdir mountpoint
$ mount /dev/loop7 mountpoint
$ cd mountpoint
$ echo ""This is a write-only file"" > target
$ chmod 200 target
$ ./exploit target output
$ cat output
This is a write-only file
Comment 4
Fedora Update System
          2010-05-27 21:25:14 UTC
kernel-2.6.33.5-112.fc13 has been submitted as an update for Fedora 13.
http://admin.fedoraproject.org/updates/kernel-2.6.33.5-112.fc13
Comment 5
Fedora Update System
          2010-05-28 06:59:28 UTC
kernel-2.6.32.14-127.fc12 has been submitted as an update for Fedora 12.
http://admin.fedoraproject.org/updates/kernel-2.6.32.14-127.fc12
Comment 6
Fedora Update System
          2010-05-31 18:30:23 UTC
kernel-2.6.33.5-112.fc13 has been pushed to the Fedora 13 stable repository.  If problems still persist, please make note of it in this bug report.
Comment 7
Fedora Update System
          2010-06-14 17:13:40 UTC
kernel-2.6.32.14-127.fc12 has been pushed to the Fedora 12 stable repository.  If problems still persist, please make note of it in this bug report.
"
